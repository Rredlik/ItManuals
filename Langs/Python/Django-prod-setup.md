Конечно, я с удовольствием подготовлю для вас подробное руководство. Мы превратим наш сеанс отладки в четкую инструкцию, чтобы вы или кто-то другой могли легко развернуть проект в будущем.

Вот гайд в формате Markdown (`.md`). Вы можете сохранить его и использовать как шпаргалку.

```markdown
# Развертывание Django-проекта на Ubuntu 22.04 с Nginx и Gunicorn

Этот гайд описывает полный процесс развертывания проекта на Django с нуля на чистом сервере Ubuntu 22.04.

**Стек технологий:**
*   **Веб-сервер (Reverse Proxy):** Nginx
*   **Сервер приложений (WSGI):** Gunicorn
*   **Управление процессами:** systemd (через сокеты)
*   **ОС:** Ubuntu 22.04 LTS

---

## Часть 1: Подготовка сервера

Эти шаги выполняются на свежеустановленном сервере Ubuntu.

### 1.1. Обновление системы
Первым делом обновим список пакетов и сами пакеты.

```bash
sudo apt update
sudo apt upgrade -y```

### 1.2. Установка необходимого ПО
Нам понадобятся Python, инструменты для управления пакетами и виртуальными окружениями, Nginx и библиотека для работы с PostgreSQL (даже если вы используете другую БД, она может понадобиться для зависимостей).

```bash
sudo apt install python3-pip python3-dev python3-venv libpq-dev nginx curl -y
```
*   `python3-pip`: Установщик пакетов Python.
*   `python3-dev`: Заголовочные файлы для сборки некоторых Python-пакетов.
*   `python3-venv`: Для создания виртуальных окружений.
*   `libpq-dev`: Необходимо для сборки `psycopg2`, популярного драйвера для PostgreSQL.
*   `nginx`: Наш веб-сервер.
*   `curl`: Утилита для тестирования веб-запросов.

---

## Часть 2: Настройка проекта и окружения

Теперь подготовим код вашего проекта к запуску.

### 2.1. Загрузка проекта
Обычно проект загружается из Git-репозитория. Замените `ВАШ_ПОЛЬЗОВАТЕЛЬ` на ваше имя пользователя на сервере, а `URL_ВАШЕГО_РЕПОЗИТОРИЯ` на ссылку на ваш Git-репозиторий.

```bash
# Переходим в домашнюю директорию
cd /home/ВАШ_ПОЛЬЗОВАТЕЛЬ/

# Клонируем проект
git clone URL_ВАШЕГО_РЕПОЗИТОРИЯ имя_проекта

# Переходим в папку проекта
cd имя_проекта
```

### 2.2. Создание и активация виртуального окружения
Всегда используйте виртуальное окружение, чтобы изолировать зависимости проекта.

```bash
# Создаем окружение с именем venv
python3 -m venv venv

# Активируем его
source venv/bin/activate
```
После активации в начале строки терминала появится `(venv)`.

### 2.3. Установка зависимостей
Установим Gunicorn и все зависимости проекта из вашего файла `requirements.txt`.

```bash
# Убедитесь, что venv активно
pip install wheel
pip install gunicorn
pip install -r requirements.txt
```

### 2.4. Настройка `settings.py` для продакшена
Откройте файл настроек вашего проекта (например, `имя_проекта/settings.py`) и внесите следующие изменения:

1.  **`DEBUG = False`**: Это самое важное правило безопасности.
2.  **`ALLOWED_HOSTS`**: Укажите IP-адрес вашего сервера и доменное имя (если есть).
    ```python
    ALLOWED_HOSTS = ['ВАШ_IP_АДРЕС', 'ваш_домен.com']
    ```
3.  **`STATIC_ROOT`**: Укажите Django, куда складывать все статические файлы (CSS, JS, картинки) после сборки.
    ```python
    import os
    # ...
    STATIC_URL = '/static/'
    STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles') # Папка для собранной статики

    MEDIA_URL = '/media/'
    MEDIA_ROOT = os.path.join(BASE_DIR, 'media') # Папка для загруженных пользователями файлов
    ```

### 2.5. Сборка статики и миграции
Применим миграции базы данных и соберем все статические файлы в папку, указанную в `STATIC_ROOT`.

```bash
# Убедитесь, что venv активно
python manage.py makemigrations
python manage.py migrate
python manage.py collectstatic
```
На запрос `Type 'yes' to continue:` введите `yes`.

---

## Часть 3: Настройка Gunicorn через systemd

Мы настроим Gunicorn так, чтобы он управлялся операционной системой и запускался автоматически. Мы будем использовать "активацию по сокету" — это самый надежный метод.

### 3.1. Создание systemd-файла для сокета
Этот файл прикажет `systemd` создать сокет-файл, который будет "слушать" запросы.

Откройте новый файл:
```bash
sudo nano /etc/systemd/system/gunicorn.socket
```
Вставьте в него следующий текст:
```ini
[Unit]
Description=gunicorn socket

[Socket]
ListenStream=/run/gunicorn.sock

[Install]
WantedBy=sockets.target
```

### 3.2. Создание systemd-файла для сервиса
Этот файл описывает сам сервис Gunicorn. Он будет запускаться только тогда, когда на сокет придет первый запрос.

Откройте новый файл:
```bash
sudo nano /etc/systemd/system/gunicorn.service
```
Вставьте в него следующий текст, **заменив `ВАШ_ПОЛЬЗОВАТЕЛЬ` и `имя_проекта` на ваши**:

```ini
[Unit]
Description=gunicorn daemon for имя_проекта
Requires=gunicorn.socket
After=network.target

[Service]
User=ВАШ_ПОЛЬЗОВАТЕЛЬ
Group=www-data
WorkingDirectory=/home/ВАШ_ПОЛЬЗОВАТЕЛЬ/имя_проекта
ExecStart=/home/ВАШ_ПОЛЬЗОВАТЕЛЬ/имя_проекта/venv/bin/gunicorn \
          --access-logfile - \
          --workers 3 \
          имя_проекта.wsgi:application

[Install]
WantedBy=multi-user.target
```
*   `User`: Пользователь, от которого будет работать Gunicorn.
*   `Group=www-data`: Важно, чтобы Nginx мог получить доступ к сокету.
*   `WorkingDirectory`: Путь к папке с вашим `manage.py`.
*   `ExecStart`: Команда запуска Gunicorn.

### 3.3. Запуск и активация Gunicorn
Теперь запустим и добавим в автозагрузку наши новые службы.

```bash
# Перезагружаем systemd, чтобы он увидел новые файлы
sudo systemctl daemon-reload

# Запускаем и активируем сокет. Сервис запустится сам по требованию.
sudo systemctl start gunicorn.socket
sudo systemctl enable gunicorn.socket

# Проверяем статус сокета
sudo systemctl status gunicorn.socket
```
Вывод должен показать `active (listening)`.

---

## Часть 4: Настройка Nginx

Nginx будет принимать внешние запросы и передавать их Gunicorn, а также самостоятельно отдавать статику.

### 4.1. Создание конфигурационного файла Nginx
Создадим отдельный конфиг для нашего сайта.

```bash
sudo nano /etc/nginx/sites-available/имя_проекта
```
Вставьте в него следующий текст, **заменив `ВАШ_IP_АДРЕС`, `ВАШ_ПОЛЬЗОВАТЕЛЬ` и `имя_проекта` на ваши**:

```nginx
server {
    listen 80;
    server_name ВАШ_IP_АДРЕС ваш_домен.com;

    location = /favicon.ico { access_log off; log_not_found off; }

    location /static/ {
        alias /home/ВАШ_ПОЛЬЗОВАТЕЛЬ/имя_проекта/static/;
    }

    location /media/ {
        alias /home/ВАШ_ПОЛЬЗОВАТЕЛЬ/имя_проекта/media/;
    }

    location / {
        include proxy_params;
        proxy_pass http://unix:/run/gunicorn.sock;
    }
}
```
*   **`alias`**: Это правильная директива для статики. Она сопоставляет URL с папкой на диске.

### 4.2. Активация конфига и перезапуск Nginx

```bash
# Создаем символическую ссылку, чтобы активировать конфиг
sudo ln -s /etc/nginx/sites-available/имя_проекта /etc/nginx/sites-enabled/

# Удаляем стандартный сайт Nginx, чтобы не было конфликтов (если есть)
sudo rm /etc/nginx/sites-enabled/default

# Проверяем синтаксис Nginx
sudo nginx -t
# Вывод должен быть: ...test is successful

# Перезапускаем Nginx
sudo systemctl restart nginx
```

### 4.3. Настройка прав доступа
Это **критически важный шаг**. Nginx работает от пользователя `www-data`, которому по умолчанию запрещено входить в домашние директории других пользователей.

```bash
# Даем Nginx право "входить" в вашу домашнюю папку, но не читать ее содержимое
sudo chmod 751 /home/ВАШ_ПОЛЬЗОВАТЕЛЬ
```

Теперь откройте в браузере `http://ВАШ_IP_АДРЕС`. Ваш сайт должен работать!

---

## Часть 5: Устранение распространенных ошибок

Если что-то пошло не так, вот как это исправить.

### Ошибка 1: Стили (CSS) не загружаются (404 Not Found)

Это самая частая проблема.

*   **Симптом:** Сайт работает, но выглядит "голым", без стилей. В консоли браузера (F12 -> Network) у CSS-файлов статус 404.
*   **Причина №1:** Вы забыли запустить `python manage.py collectstatic`.
    *   **Решение:** Запустите команду в активном `venv`.
*   **Причина №2:** Ошибка в пути в конфиге Nginx.
    *   **Решение:** Убедитесь, что в блоках `location /static/` и `location /media/` используется директива **`alias`**, а не `root`. Проверьте, что путь в `alias` абсолютно верный и заканчивается на `/`.
*   **Причина №3:** Неправильно сгенерирован URL в HTML-шаблоне.
    *   **Решение:** Откройте шаблон. Убедитесь, что в самом верху есть `{% load static %}`, а ссылка на CSS выглядит так: `<link rel="stylesheet" href="{% static 'путь/от/static/style.css' %}">`. Если это не работает, проверьте, не использует ли Django другой шаблон-двойник (см. Ошибку 5).

### Ошибка 2: 502 Bad Gateway

*   **Симптом:** Nginx не может связаться с Gunicorn.
*   **Диагностика:** `sudo systemctl status gunicorn.service`.
*   **Причина №1:** Сервис Gunicorn упал с ошибкой.
    *   **Решение:** Посмотрите на вывод `status`. Там будут строки с ошибкой, которые укажут на проблему (например, ошибка в Python-коде).
*   **Причина №2:** Проблема с правами доступа к сокету.
    *   **Диагностика:** `sudo tail -f /var/log/nginx/error.log`. Если видите `(13: Permission denied)` при попытке `connect() to unix:/run/gunicorn.sock`, то это оно.
    *   **Решение:** Убедитесь, что в `gunicorn.service` указан `Group=www-data`, а для домашней папки выполнена команда `sudo chmod 751 /home/ВАШ_ПОЛЬЗОВАТЕЛЬ`.

### Ошибка 3: Изменения в коде (`.py` файлах) не применяются

*   **Симптом:** Вы изменили `views.py` или `urls.py`, но сайт ведет себя по-старому.
*   **Причина:** Gunicorn работает со старой, закешированной версией кода.
*   **Решение:**
    1.  Принудительно перезапустите Gunicorn: `sudo systemctl restart gunicorn.service`.
    2.  Если не помогло, удалите кеш вручную: `cd /путь/к/проекту` и `find . -path "*/__pycache__" -exec rm -r {} +`, затем снова перезапустите сервис.

### Ошибка 4: Django использует не тот шаблон

*   **Симптом:** Вы меняете HTML-шаблон, но на сайте ничего не меняется. Ссылки на статику генерируются неправильно, даже с тегом `{% static %}`.
*   **Причина:** Django нашел в другом месте вашего проекта файл-двойник с таким же именем (часто из `django.contrib.admin`).
*   **Диагностика:**
    1.  Временно переименуйте ваш шаблон (`mv template.html template.html.BAK`). Если сайт не упал с ошибкой `TemplateDoesNotExist`, значит, используется двойник.
    2.  Найдите всех двойников: `cd /путь/к/проекту` и `find . -name "имя_шаблона.html"`.
*   **Решение:** Явно укажите Django, какой шаблон использовать. В вашем `urls.py` создайте собственный `View`, наследующий от стандартного, и переопределите в нем `template_name`:
    ```python
    # в urls.py
    from django.contrib.auth.views import LoginView
    # импортируйте ваше view, если оно в другом файле

    class CustomLoginView(LoginView):
        template_name = 'ваше_приложение/имя_шаблона.html'

    urlpatterns = [
        # ...
        path('login/', CustomLoginView.as_view(), name='login'),
        # ...
    ]
    ```
    Не забудьте перезапустить Gunicorn после изменения `.py` файлов.