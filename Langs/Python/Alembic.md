# Система контроля версий для БД - Alembic Guide

Alembic is a database migration tool for Python and SQLAlchemy. It allows you to manage changes to your database schema over time.

## Installation

To install Alembic, you can use pip:

```bash
pip install alembic
```

## Initializing an Alembic Environment

Once Alembic is installed, you need to initialize an Alembic environment in your project. This is done using the `alembic init` command:

```bash
alembic init alembic
```

This command will create a directory named `alembic` in your project, along with a configuration file `alembic.ini`.
The `alembic` directory will contain a `versions` subdirectory, which is where your migration scripts will be stored.
It also creates an `env.py` file, which is used to configure how Alembic connects to your database.

## Configuring the Database Connection

You need to configure Alembic to connect to your database. This is done by editing the `env.py` file in the `alembic` directory.

You'll need to set the `sqlalchemy.url` variable in `alembic.ini` or provide your database connection URL directly in `env.py`.

For example, to connect to a PostgreSQL database, you might set `sqlalchemy.url` in `alembic.ini` like this:

```ini
sqlalchemy.url = postgresql://user:password@host/dbname
```

Alternatively, in `env.py`, you can find the `config.set_main_option("sqlalchemy.url", "...")` line and update it, or set up the engine directly.

It's also important to ensure that your SQLAlchemy models are loaded so that Alembic's autogenerate feature can detect changes. You typically do this by importing your model definitions into `env.py` and setting `target_metadata`:

```python
# In env.py
from myapp.models import Base  # Предполагается, что ваши модели используют декларативную базу SQLAlchemy
target_metadata = Base.metadata
```

## Creating a New Migration

Once your environment is configured, you can create a new migration script using the `alembic revision` command:

```bash
alembic revision -m "create account table"
```

This will generate a new file in your `alembic/versions` directory (e.g., `versions/xxxxxxxxxxxx_create_account_table.py`). The `xxxxxxxxxxxx` part is a unique identifier.

You then edit this file to define the changes you want to make to your database schema. Alembic provides operations like `op.create_table()`, `op.add_column()`, etc.

For example, a migration script to create an `account` table might look like this:

```python
"""создание таблицы account

ID ревизии: xxxxxxxxxxxx  # Замените на актуальный ID
Revises: 
Дата создания: YYYY-MM-DD HH:MM:SS.ssssss

"""
from alembic import op
import sqlalchemy as sa


# идентификаторы ревизии, используемые Alembic.
revision = 'xxxxxxxxxxxx' # Замените на актуальный ID
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    op.create_table(
        'account',
        sa.Column('id', sa.Integer, primary_key=True),
        sa.Column('name', sa.String(50), nullable=False),
        sa.Column('description', sa.Unicode(200)),
    )


def downgrade():
    op.drop_table('account')

```
**Примечание:** Переменные `revision`, `down_revision`, `branch_labels` и `depends_on`, а также строка документации (docstring), генерируются Alembic автоматически. Обычно вам нужно только заполнить функции `upgrade()` и `downgrade()`. Пример таблицы `account` включает столбцы `id`, `name` и `description`.

Alembic can also attempt to automatically generate migration scripts based on changes to your SQLAlchemy models. This is called "autogenerate":

```bash
alembic revision -m "add user email column" --autogenerate
```
It's crucial to review autogenerated migrations carefully before applying them.

## Applying Migrations

To apply migrations to your database (i.e., run the `upgrade()` function in your migration scripts), use the `alembic upgrade` command:

```bash
alembic upgrade head
```
This command applies all pending migrations up to the latest one (referred to as `head`).

You can also upgrade to a specific revision:
```bash
alembic upgrade <revision_id>
```

To see the current revision of the database:
```bash
alembic current
```

To view the history of migrations:
```bash
alembic history
```

## Reverting Migrations

To revert migrations (i.e., run the `downgrade()` function in your migration scripts), use the `alembic downgrade` command.

To revert the last applied migration:
```bash
alembic downgrade -1
```

To revert to a specific revision:
```bash
alembic downgrade <revision_id>
```

To revert all migrations:
```bash
alembic downgrade base
```
It's important to ensure your `downgrade()` functions are correctly implemented to reverse the changes made in the `upgrade()` function.

## Best Practices and Further Reading

*   **Always review autogenerated migrations:** Autogenerate is a helpful tool, but it's not perfect. Always review the generated script to ensure it accurately reflects the intended changes and doesn't include anything unexpected.
*   **Test your migrations:** Especially for complex migrations, test them in a development or staging environment before applying them to production.
*   **Keep migrations small and focused:** Each migration should represent a single, atomic change to the schema. This makes them easier to understand, test, and debug.
*   **Ensure `downgrade` functions are robust:** Thoroughly test your `downgrade` functions to ensure they correctly revert the schema changes.
*   **Version control your migration scripts:** Treat your `alembic` directory and its contents as part of your application's source code.

For more detailed information, refer to the official Alembic documentation:
*   [Alembic Tutorial](https://alembic.sqlalchemy.org/en/latest/tutorial.html)
*   [Alembic Operations Reference](https://alembic.sqlalchemy.org/en/latest/ops.html)

This guide provides a basic overview of using Alembic. Happy migrating!
